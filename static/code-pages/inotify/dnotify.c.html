<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>dnotify.c - TLPI</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#1e1e1e;color:#d4d4d4;min-height:100vh}
    .header{background:#252526;padding:16px 24px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #3c3c3c;flex-wrap:wrap;gap:12px}
    .file-info{display:flex;flex-direction:column;gap:4px}
    .filename{font-size:1.25rem;font-weight:600;color:#fff}
    .category{font-size:0.875rem;color:#808080}
    .file-type{display:inline-block;padding:2px 8px;background:#555555;color:#fff;border-radius:4px;font-size:0.75rem;font-weight:600;margin-left:8px}
    .actions{display:flex;gap:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;border:none;border-radius:6px;font-size:0.875rem;font-weight:500;cursor:pointer;transition:all 0.2s}
    .btn-copy{background:#0e639c;color:#fff}
    .btn-copy:hover{background:#1177bb}
    .btn-copy.copied{background:#16825d}
    .btn-download{background:#10b981;color:#fff}
    .btn-download:hover{background:#059669}
    .btn svg{width:16px;height:16px}
    #editor{height:calc(100vh - 80px)}
    .toast{position:fixed;bottom:24px;right:24px;background:#16825d;color:#fff;padding:12px 24px;border-radius:8px;font-size:0.875rem;opacity:0;transform:translateY(20px);transition:all 0.3s;z-index:1000}
    .toast.show{opacity:1;transform:translateY(0)}
    .lines{font-size:0.75rem;color:#6b7280;margin-top:4px}
  </style>
</head>
<body>
  <div class="header">
    <div class="file-info">
      <div class="filename">dnotify.c<span class="file-type">C Source</span></div>
      <div class="category">inotify</div>
      <div class="lines" id="lines"></div>
    </div>
    <div class="actions">
      <button class="btn btn-copy" id="copyBtn" onclick="copyCode()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
        <span id="copyText">Copy</span>
      </button>
      <button class="btn btn-download" onclick="downloadCode()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
        <span>Download</span>
      </button>
    </div>
  </div>
  <div id="editor"></div>
  <div class="toast" id="toast"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
  <script>
    const CODE=`/*************************************************************************\\
*                  Copyright (C) Michael Kerrisk, 2025.                   *
*                                                                         *
* This program is free software. You may use, modify, and redistribute it *
* under the terms of the GNU General Public License as published by the   *
* Free Software Foundation, either version 3 or (at your option) any      *
* later version. This program is distributed without any warranty.  See   *
* the file COPYING.gpl-v3 for details.                                    *
\\*************************************************************************/

/* Supplementary program for Chapter 19 */

/* dnotify.c

   Demonstrate the use of the (obsolete) dnotify feature to obtain directory
   change notifications. (Modern programs should use inotify instead of
   dnotify. The inotify API is available in Linux 2.6.13 and later.)

   Usage is as shown in usageError() below. An example is the following:

        dnotify dir1:a xyz/dir2:acdM

   See also demo_inotify.c.

   This program is Linux-specific.
*/
#define _GNU_SOURCE             /* To get DN_* constants from <fcntl.h> */
#include <fcntl.h>
#include <signal.h>
#include "tlpi_hdr.h"

static void             /* Print (optional) message and usage info, then exit */
usageError(const char *progName, const char *msg)
{
    if (msg != NULL)
        fprintf(stderr, "%s", msg);

    fprintf(stderr, "Usage: %s directory:[events]...\\n", progName);
    fprintf(stderr, "    Events are:\\n"
        "        a - access; A - attrib; c - create; d - delete\\n"
        "        m - modify; r - rename; M - multishot\\n"
        "        (default is all events)\\n");
    exit(EXIT_FAILURE);
}

static void
handler(int sig, siginfo_t *si, void *ucontext)
{
    printf("Got event on descriptor %d\\n", si->si_fd);
                        /* UNSAFE (see Section 21.1.2) */
}

int
main(int argc, char *argv[])
{
    if (argc < 2 || strcmp(argv[1], "--help") == 0)
        usageError(argv[0], NULL);

    /* Establish handler for notification signal */

    const int NOTIFY_SIG = SIGRTMIN;

    struct sigaction sa;
    sa.sa_sigaction = handler;
    sigemptyset(&sa.sa_mask);
    sa.sa_flags = SA_SIGINFO;           /* So handler gets siginfo_t arg. */
    if (sigaction(NOTIFY_SIG, &sa, NULL) == -1)
        errExit("sigaction");

    for (int fnum = 1; fnum < argc; fnum++) {
        int events;
        char *p = strchr(argv[fnum], ':');      /* Look for optional ':' */

        if (p == NULL) {                /* Default is all events + multishot */
            events = DN_ACCESS | DN_ATTRIB | DN_CREATE | DN_DELETE |
                     DN_MODIFY | DN_RENAME | DN_MULTISHOT;
        } else {                        /* ':' present, parse event chars */
            *p = '\\0';                  /* Terminates directory component */
            events = 0;
            for (p++; *p != '\\0'; p++) {
                switch (*p) {
                case 'a': events |= DN_ACCESS;          break;
                case 'A': events |= DN_ATTRIB;          break;
                case 'c': events |= DN_CREATE;          break;
                case 'd': events |= DN_DELETE;          break;
                case 'm': events |= DN_MODIFY;          break;
                case 'r': events |= DN_RENAME;          break;
                case 'M': events |= DN_MULTISHOT;       break;
                default:  usageError(argv[0], "Bad event character\\n");
                }
            }
        }

        /* Obtain a file descriptor for the directory to be monitored */

        int fd = open(argv[fnum], O_RDONLY);
        if (fd == -1)
            errExit("open");
        printf("opened '%s' as file descriptor %d\\n", argv[fnum], fd);

        /* Use alternate signal instead of SIGIO for dnotify events */

        if (fcntl(fd, F_SETSIG, NOTIFY_SIG) == -1)
            errExit("fcntl - F_SETSIG");

        /* Enable directory change notifications */

        if (fcntl(fd, F_NOTIFY, events) == -1)
            errExit("fcntl-F_NOTIFY");
        printf("events: %o\\n", (unsigned int) events);
    }

    for (;;)
        pause();                        /* Wait for events */
}
`;
    const FILENAME='dnotify.c';
    document.getElementById('lines').textContent=CODE.split('\n').length+' lines';
    require.config({paths:{vs:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs'}});
    require(['vs/editor/editor.main'],function(){
      monaco.editor.create(document.getElementById('editor'),{
        value:CODE,language:'c',theme:'vs-dark',readOnly:true,automaticLayout:true,
        fontSize:14,lineNumbers:'on',minimap:{enabled:true},scrollBeyondLastLine:false,
        padding:{top:16,bottom:16},folding:true,bracketPairColorization:{enabled:true}
      });
    });
    function copyCode(){
      navigator.clipboard.writeText(CODE).then(()=>{
        document.getElementById('copyBtn').classList.add('copied');
        document.getElementById('copyText').textContent='Copied!';
        showToast('Copied!');
        setTimeout(()=>{document.getElementById('copyBtn').classList.remove('copied');document.getElementById('copyText').textContent='Copy';},2000);
      });
    }
    function downloadCode(){
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([CODE],{type:'text/plain'}));
      a.download=FILENAME;a.click();
      showToast('Download started!');
    }
    function showToast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);}
  </script>
</body>
</html>