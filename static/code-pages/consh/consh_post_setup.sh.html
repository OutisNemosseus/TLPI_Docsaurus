<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>consh_post_setup.sh - TLPI</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#1e1e1e;color:#d4d4d4;min-height:100vh}
    .header{background:#252526;padding:16px 24px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #3c3c3c;flex-wrap:wrap;gap:12px}
    .file-info{display:flex;flex-direction:column;gap:4px}
    .filename{font-size:1.25rem;font-weight:600;color:#fff}
    .category{font-size:0.875rem;color:#808080}
    .file-type{display:inline-block;padding:2px 8px;background:#4eaa25;color:#fff;border-radius:4px;font-size:0.75rem;font-weight:600;margin-left:8px}
    .actions{display:flex;gap:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;border:none;border-radius:6px;font-size:0.875rem;font-weight:500;cursor:pointer;transition:all 0.2s}
    .btn-copy{background:#0e639c;color:#fff}
    .btn-copy:hover{background:#1177bb}
    .btn-copy.copied{background:#16825d}
    .btn-download{background:#10b981;color:#fff}
    .btn-download:hover{background:#059669}
    .btn svg{width:16px;height:16px}
    #editor{height:calc(100vh - 80px)}
    .toast{position:fixed;bottom:24px;right:24px;background:#16825d;color:#fff;padding:12px 24px;border-radius:8px;font-size:0.875rem;opacity:0;transform:translateY(20px);transition:all 0.3s;z-index:1000}
    .toast.show{opacity:1;transform:translateY(0)}
    .lines{font-size:0.75rem;color:#6b7280;margin-top:4px}
  </style>
</head>
<body>
  <div class="header">
    <div class="file-info">
      <div class="filename">consh_post_setup.sh<span class="file-type">Shell Script</span></div>
      <div class="category">consh</div>
      <div class="lines" id="lines"></div>
    </div>
    <div class="actions">
      <button class="btn btn-copy" id="copyBtn" onclick="copyCode()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
        <span id="copyText">Copy</span>
      </button>
      <button class="btn btn-download" onclick="downloadCode()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
        <span>Download</span>
      </button>
    </div>
  </div>
  <div id="editor"></div>
  <div class="toast" id="toast"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
  <script>
    const CODE=`#!/bin/sh
#
# consh_post_setup.sh
#
# (C) 2025, Michael Kerrisk
#
# Licensed under the GNU General Public License version 2 or later

# In the following steps, we create the mount that will be used as the root
# filesystem in the container. The mount is a union mount built by using
# OverlayFS to combine a set of directories created under <fs-dir>.
# (Since Linux 5.11 (2021), it possible to create such a mount in noninitial
# user + mount NSs created by unprivileged users.)

if [ -n "\$VERBOSE" ] ; then
    echo "=========="
fi

unset ENV

mkdir -p \$OVLY_DIR

if [ -n "\$VERBOSE" ] ; then
    echo "Creating overlay dirs in '\$OVLY_DIR'"
fi
mkdir \$OVLY_DIR/upper \$OVLY_DIR/work
	# Avoid "mkdir -p \$OVLY_DIR/{upper,work}"
	# because not supported by busybox shell

mkdir \$OVLY_DIR/merged		# Create mount point

if [ -n "\$VERBOSE" ] ; then
    echo "Creating overlay mount at '\$OVLY_DIR/merged'"
fi
mount -t overlay \\
		-o lowerdir=\$LOWER \\
		-o upperdir=\$OVLY_DIR/upper \\
		-o  workdir=\$OVLY_DIR/work \\
		    overlay \$OVLY_DIR/merged

cd \$OVLY_DIR
unset LOWER OVLY_DIR		# No longer needed

# As a demonstration, create a file that is private to this container.

manifest=merged/MANIFEST
echo "Created at:  \$(date)"   > \$manifest
echo "Creator UID: \$(id -u)" >> \$manifest
echo "Creator PID: \$\$"       >> \$manifest

# Set up the root filesystem for the container.

if [ -n "\$VERBOSE" ] ; then
    echo "Preparing for pivot root"
fi

mount --make-rprivate /
mount --bind merged merged
mkdir merged/oldrootfs

if [ -n "\$VERBOSE" ] ; then
    echo "Pivoting root (pivoting to 'merged'; placing old root FS at merged/oldrootfs/)"
fi

pivot_root merged merged/oldrootfs/

# Our current directory is outside the root directory. Switch it to new
# root directory.

cd /

# Mount various namespace-related pseudofilesystems.

if [ -n "\$VERBOSE" ] ; then
    echo "Mounting filesystems"
fi

mount -t proc proc /proc

mount -t sysfs sysfs /sys
mount -t cgroup2 cgroup2 /sys/fs/cgroup

mkdir -p /dev/mqueue
mount -t mqueue mqueue /dev/mqueue

# In Podman and Docker, there is a 'tmpfs' mount at /dev. However, I found
# that if I simply do the following before creating the devices (and the
# /dev/mqueue mount):
#
#	mount -t tmpfs tmpfs /dev
#
# then the devices don't have the right behavior. In particular, various
# devices get errors such as the following:
#
#       \$ date > /dev/null
#	sh: can't create /dev/null: Permission denied
#
# I have not dug deep enough to work out why this happens. Perhaps it
# relates to the notion of "locked mounts" described in mount_namespaces(7).
# One interesting thing I noticed was that if I instead started the
# container without creating any /dev mounts in this script, then from
# another terminal window (in the initial user namespace) I could use
# "nsenter -t PID -m -p" to step into the mount namespace of the container
# and then successfully mount tmpfs at /dev and then bind mount the devices.
# Podman does a dance in order to mount tmpfs at /dev while at the same time
# avoiding this problem; I've yet to dig into the details.

if [ -n "\$VERBOSE" ] ; then
    echo "Creating devices"
fi

for name in full null random tty urandom zero; do
    touch /dev/\$name
    mount --bind oldrootfs/dev/\$name /dev/\$name
done

# Instead of making bind mounts as above, after the container has been started
# it would also be possible to make the devices by performing mknod(1) in the
# appropriate directory, from a privileged shell in the initial user namespace.
# (As noted in user_namespaces(7) mknod(1) can be used only by a process that
# is privileged in the initial user namespace.)

# We could also do the following:
#
#    mkdir /dev/pts
#    mount -t devpts devpts /dev/pts     # Pseudoterminal FS
#    ln -s /dev/pts/ptmx /dev/ptmx
#
#    mkdir /dev/shm
#    mount -t tmpfs shm /dev/shm         # For POSIX shared memory

# The umount of oldrootfs needs to be done after creating the /proc mount.
# As far as I can tell, the reason is that outlined in this mail message:
# https://lists.linuxfoundation.org/pipermail/containers/2018-April/038840.html
# https://lore.kernel.org/lkml/87tvsrjai0.fsf@xmission.com/T/
# That message notes:
#
#     Since Linux v4.2 with commit 1b852bceb0d1 ("mnt: Refactor the logic for
#     mounting sysfs and proc in a user namespace"), new mounts of proc or
#     sysfs in non init userns are only allowed when there is at least one
#     fully-visible proc or sysfs mount.
#
# The kernel commit is:
#
#   commit 1b852bceb0d111e510d1a15826ecc4a19358d512
#   Author: Eric W. Biederman <ebiederm@xmission.com>
#   Date:   Fri May 8 23:22:29 2015 -0500
#
#       mnt: Refactor the logic for mounting sysfs and proc in a user namespace

# At this point, we no longer need the old root FS, so unmount it.

if [ -n "\$VERBOSE" ] ; then
    echo "Unmounting 'oldrootfs'"
fi

umount -l oldrootfs
rmdir oldrootfs

# Set the hostname

hostname \$HOSTNAME

# Create README file inside the container with some suggestions about
# commands to try out inside the container.

cat << 'EOF' > README
# Try some of the following commands, to see how things look:

mount
ps
ls /proc
echo \$\$
readlink /proc/\$\$/ns/user
cat /proc/\$\$/uid_map
id
grep Cap /proc/\$\$/status
hostname
hostname new-host-name
cat /proc/\$\$/cgroup
ls /bin
EOF

unset VERBOSE
`;
    const FILENAME='consh_post_setup.sh';
    document.getElementById('lines').textContent=CODE.split('\n').length+' lines';
    require.config({paths:{vs:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs'}});
    require(['vs/editor/editor.main'],function(){
      monaco.editor.create(document.getElementById('editor'),{
        value:CODE,language:'shell',theme:'vs-dark',readOnly:true,automaticLayout:true,
        fontSize:14,lineNumbers:'on',minimap:{enabled:true},scrollBeyondLastLine:false,
        padding:{top:16,bottom:16},folding:true,bracketPairColorization:{enabled:true}
      });
    });
    function copyCode(){
      navigator.clipboard.writeText(CODE).then(()=>{
        document.getElementById('copyBtn').classList.add('copied');
        document.getElementById('copyText').textContent='Copied!';
        showToast('Copied!');
        setTimeout(()=>{document.getElementById('copyBtn').classList.remove('copied');document.getElementById('copyText').textContent='Copy';},2000);
      });
    }
    function downloadCode(){
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([CODE],{type:'text/plain'}));
      a.download=FILENAME;a.click();
      showToast('Download started!');
    }
    function showToast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);}
  </script>
</body>
</html>